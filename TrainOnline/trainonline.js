MAX_RETRY_COUNT=5;String.prototype.contains=function(e){var a=e.substring(0,1);var d=e.length;for(var c=0;c<this.length-d+1;c++){if(this.charAt(c)==a){if(this.substring(c,c+d)==e){return true}}}return false};String.prototype.startsWith=function(a){return(this.indexOf(a)===0)};String.prototype.getString=function(e,d){var c=this.indexOf(e);if(c<0){return""}c+=+e.length;if(d){var a=this.indexOf(d,c);if(a<0){return""}return this.substr(c,a-c).trim().replace("&nbsp;"," ")}else{return this.substr(c).replace("&nbsp;"," ")}};String.prototype.removeComment=function(){var c="";var a=0;while(true){var e=this.indexOf("<!--",a);if(e<0){break}c+=this.substr(a,e-a);var d=this.indexOf("-->",e+1);if(d<0){break}a=d+1}return c.replace("&nbsp;"," ")};String.prototype.removeHtmlTag=function(){var e=this.indexOf("<");if(e<0){return this}var c="";var a=0;while(true){c+=this.substr(a,e-a);var d=this.indexOf(">",e+1);if(d<0){break}a=d+1;e=this.indexOf("<",a);if(e<0){break}}return c.replace("&nbsp;"," ")};String.prototype.getTdText=function(){var a=this.getString(">","</td>");return a.removeHtmlTag().trim()};String.prototype.format=function(){var a=arguments;return this.replace(/{(\d+)}/g,function(c,d){return(typeof a[d]!=="undefined"?a[d]:c)})};Array.prototype.clear=function(){this.length=0};Array.prototype.insertAt=function(a,c){this.splice(a,0,c)};Array.prototype.removeAt=function(a){this.splice(a,1)};Array.prototype.remove=function(c){var a=this.indexOf(c);if(a>=0){this.removeAt(a)}};Array.prototype.removeByKey=function(c){for(var a=0;a<this.length;++a){if(this[a]==c){this.splice(a,1);return}}};function strToJson(str){var json=eval("("+str+")");return json}function jsonToStr(d){var a;if(d instanceof Array){a=[];for(var c=0;c<d.length;c++){a.push(jsonToStr(d[c]))}return"["+a.join(",")+"]"}else{if(d instanceof Object){a=[];for(var e in d){a.push('"'+e+'":'+jsonToStr(d[e]))}return"{"+a.join(",")+"}"}else{if(typeof d=="string"){return'"'+d.replace(/(\\|\")/g,"\\$1").replace(/\n/g,"\\n")+'"'}else{return d}}}}function throwError(d){var c=d.messages;if(c!==undefined){var e=c[0];throw e}else{var a=d.message;if(a!==undefined){throw a}else{throw"错误！"}}}var ctx="https://kyfw.12306.cn/otn/";var userInfo=null;var isTest=false;var ticketQuery=new function(){function a(f,e,d){if(f.length>0&&(f!="--")){var g=f.charAt(0);if(g>="0"&&g<="9"){f+="张"}d+=e+":"+f+" "}return d}this.leftTicketQuery=function(l,p,c,r){var j="https://kyfw.12306.cn/otn/leftTicket/log?leftTicketDTO.train_date={0}&leftTicketDTO.from_station={1}&leftTicketDTO.to_station={2}&purpose_codes={3}".format(l,p,c,r);doGet(j);var f="https://kyfw.12306.cn/otn/leftTicket/queryT?leftTicketDTO.train_date={0}&leftTicketDTO.from_station={1}&leftTicketDTO.to_station={2}&purpose_codes={3}".format(l,p,c,r);var o=doGet(f);var x=strToJson(o);var y=[];var h=x.data;if(h){for(var q=0;q<h.length;q++){var t=h[q];var s=t.queryLeftNewDTO;var w=s.from_station_telecode;var m=s.canWebBuy;if(m==="N"){continue}var n=s.start_station_telecode;var u=null;if(w===n){u="始"}else{u="过"}var k=s.to_station_telecode;var d=s.end_station_telecode;var e;if(k===d){e="终"}else{e="过"}var g=a(s.swz_num,"商务","");g=a(s.tz_num,"特等",g);g=a(s.zy_num,"一等",g);g=a(s.ze_num,"二等",g);g=a(s.gr_num,"高软",g);g=a(s.rw_num,"软卧",g);g=a(s.yw_num,"硬卧",g);g=a(s.rz_num,"软座",g);g=a(s.yz_num,"硬座",g);var v=[s.station_train_code,u,s.from_station_name,s.start_time,e,s.to_station_name,s.arrive_time,s.lishi,g];y.push({"data":t,"item":v})}return y}else{throwError(x)}};this.leftTicketQuery_2=function(k,o,c,q){var f="https://kyfw.12306.cn/otn/lcxxcx/query?purpose_codes={3}&queryDate={0}&from_station={1}&to_station={2}".format(k,o,c,q);var n=doGet(f);var v=strToJson(n);var w=[];var h=v.data.datas;if(h){for(var p=0;p<h.length;p++){var r=h[p];var u=r.from_station_telecode;var l=r.canWebBuy;if(l==="N"){continue}var m=r.start_station_telecode;var s=null;if(u===m){s="始"}else{s="过"}var j=r.to_station_telecode;var d=r.end_station_telecode;var e;if(j===d){e="终"}else{e="过"}var g=a(r.swz_num,"商务","");g=a(r.tz_num,"特等",g);g=a(r.zy_num,"一等",g);g=a(r.ze_num,"二等",g);g=a(r.gr_num,"高软",g);g=a(r.rw_num,"软卧",g);g=a(r.yw_num,"硬卧",g);g=a(r.rz_num,"软座",g);g=a(r.yz_num,"硬座",g);var t=[r.station_train_code,s,r.from_station_name,r.start_time,e,r.to_station_name,r.arrive_time,r.lishi,g];w.push({"data":r,"item":t})}return w}else{throwError(v)}}}();var my12306=new function(){this.initMy12306=function(){var url="https://kyfw.12306.cn/otn/index/initMy12306";var json=doGet(url);var str=json.getString('<script xml:space="preserve">',"<\/script>");eval(""+str+"");if(user_name&&user_regard){var c=user_name+user_regard+"\n";c+="欢迎您登录中国铁路客户服务中心网站。";if(_is_active&&"N"==_is_active){c+="\n您的用户尚未激活，请你登录邮箱激活帐号车票预订。"}if(_is_needModifyPassword=="Y"){c+="\n您设置的密码安全级别较低，强烈建议您修改密码。"}if(notify_TWO_1&&"Y"==notify_TWO_1){c+="\n您的身份信息核验未通过，详见《铁路互联网购票身份核验须知》。"}else{if(notify_TWO_2&&"Y"==notify_TWO_2){c+="\n身份信息经过核验但未通过，需修改本网站所填写的身份信息内容与二代居民身份证原件完全一致，保存后状态仍显示“待核验”时，需持二代居民身份证原件到车站售票窗口或铁路客票代售点办理核验。"}else{if(notify_THREE&&"Y"==notify_THREE){c+="\n您的身份信息未经核验，需持二代居民身份证原件到车站售票窗口或铁路客票代售点办理核验。"
}else{if(notify_FOUR&&"Y"==notify_FOUR){c+="\n本网站不再支持一代居民身份证，请更改为二代居民身份证。"}else{if(notify_FIVE&&"Y"==notify_FIVE){c+="\n您的身份信息未经核验，需持在本网站填写的有效身份证件原件到车站售票窗口办理预核验。"}else{}}}}}return c}else{return"错误"}};this.queryMyOrderNoComplete=function(){var url="https://kyfw.12306.cn/otn/queryOrder/queryMyOrderNoComplete";var json=doGet(url);json=strToJson(json);if(json.data!==undefined&&json.data.orderDBList!==undefined&&json.data.orderDBList.length>0){var sequence_no=json.data.orderDBList[0].sequence_no;return{"queryMyOrderNoComplete":json,"payOrder":this.payOrder(sequence_no)}}return json};function parseVars(content){var dic={};var name="var ";var splits=content.split("\n");for(var i=0;i<splits.length;i++){var split=splits[i];if(!split.contains(name)){continue}var key=split.getString(name," =");var value=split.getString("= ",";");dic[key]=value}return dic}function getInfoFromPreserve(content){var preserve=content.getString('<script xml:space="preserve">'," /*]]>*/");var payOrderMap=parseVars(preserve);return payOrderMap}this.payOrder=function(sequence_no){var url="https://kyfw.12306.cn/otn/queryOrder/continuePayNoCompleteMyOrder";var datas={"pay_flag":"pay","sequence_no":sequence_no};var json=doPost(url,datas);json=strToJson(json);var data=json.data;if(data.existError==="Y"){var errorMsg=data.errorMsg;if(errorMsg!==undefined){throw errorMsg}else{throw"订单支付错误"}}url="https://kyfw.12306.cn/otn/payOrder/init";var content=doPost(url,datas);var info=getInfoFromPreserve(content);var content=doPost("https://kyfw.12306.cn/otn/payOrder/paycheck");var json=strToJson(content);if(json.data&&json.data.flag){var payForm=json.data.payForm;for(var key in payForm){info[key]=payForm[key]}return info}else{throwError(json)}};this.payGateWay=function(payOrderMap){var url="https://epay.12306.cn/pay/payGateway";var datas={"tranData":payOrderMap.tranData,"merSignMsg":payOrderMap.merSignMsg,"appId":payOrderMap.appId,"interfaceName":payOrderMap.interfaceName,"interfaceVersion":payOrderMap.interfaceVersion,"transType":payOrderMap.transType};var content=doPost(url,datas);var orderTimeoutDate;var merCustomIp;var splits=content.split("\n");for(var str in splits){if(str.indexOf("orderTimeoutDate")>0){orderTimeoutDate=str.getString('value="','"')}else{if(str.indexOf("merCustomIp")>0){merCustomIp=str.getString('value="','"')}}}datas.orderTimeoutDate=orderTimeoutDate;datas.merCustomIp=merCustomIp;datas.channelId="1";datas.removeByKey("interfaceName");datas.removeByKey("interfaceVersion");return datas};this.getPayOrderInfo=function(){var url=ctx+"payOrder/init?random="+Math.random();var content=doPost(url);return getInfoFromPreserve(content)};this.queryMyOrderCompleted=function(queryStartDate,queryEndDate,sequeue_train_name,come_from_flag){var datas={"come_from_flag":come_from_flag,"pageIndex":"0","pageSize":"0","queryStartDate":queryStartDate,"queryEndDate":queryEndDate,"sequeue_train_name":sequeue_train_name};var url="https://kyfw.12306.cn/otn/queryOrder/queryMyOrder";var json=doPost(url,datas);json=strToJson(json);return json};this.queryPersonInfo=function(){var url="https://kyfw.12306.cn/otn/modifyUser/initQueryUserInfo";var dic=this.queryPersonInfobase(url);userInfo=dic;return dic};function decideError(json){var data=json.data;if(data!==undefined){var existError=data.existError;var MessageInfo=data.MessageInfo;if(existError!==undefined&&existError==="Y"){throw MessageInfo.removeHtmlTag()}}else{var messages=json.messages;if(messages.length===0){throw"网络错误！"}else{throw messages[0]}}}this.savePersonInfo=function(datas,isInputPassword){var url="https://kyfw.12306.cn/otn/modifyUser/saveModifyUserInfo";datas.isInputPassword=isInputPassword;var json=doPost(url,datas);json=strToJson(json);decideError(json);datas.isInputPassword="R";json=doPost(url,datas);json=strToJson(json);decideError(json);datas.isInputPassword="A";json=doPost(url,datas);json=strToJson(json);decideError(json);userInfo["userDTO.loginUserDTO.name"].value=obj["userDTO.loginUserDTO.name"].value;userInfo["userDTO.sex_code"].value=obj["userDTO.sex_code"].value;return json};function isMyself(passengerInfo){if(userInfo===undefined||userInfo===null){return false}if(passengerInfo.passenger_id_no===userInfo["userDTO.loginUserDTO.id_no"].value&&passengerInfo.passenger_name===userInfo["userDTO.loginUserDTO.name"].value){return true}else{return false}}this.passengersQuery=function(){var url="https://kyfw.12306.cn/otn/passengers/query";var datas={"pageIndex":"1","pageSize":"1000"};var json=doPost(url,datas);json=strToJson(json);var data=json.data;var message;if(data!==undefined){var flag=data.flag;if(flag!=1){message=data.message;if(message!==undefined){throw message}}else{}}else{var messages=json.messages;if(messages!==undefined&&messages.length>0){message=messages[0];throw message}}var array=data.datas;var ret=[];for(var i=0;i<array.length;i++){var passenger=array[i];if(isMyself(passenger)){}else{ret.push(passenger)}}return ret};this.reloadPassengers=function(){var url="https://kyfw.12306.cn/otn/passengers/init";
doPost(url);return this.passengersQuery()};this.queryPassengerInfo=function(json){var url="https://kyfw.12306.cn/otn/passengers/show";var dic=this.queryPersonInfobase(url,{"passenger_id_no":json.passenger_id_no,"passenger_id_type_code":json.passenger_id_type_code,"passenger_name":json.passenger_name,"passenger_type":json.passenger_type});return dic};this.queryAddInit=function(){var url="https://kyfw.12306.cn/otn/passengers/addInit";var dic=this.queryPersonInfobase(url);return dic};this.passengersEditAdd=function(datas){var url="https://kyfw.12306.cn/otn/passengers/add";var json=doPost(url,datas);json=strToJson(json);var data=json.data;if(data!==undefined){var flag=data.flag;if(!flag){var message=data.message;if(message!==undefined){throw message}else{throw"添加失败"}}else{return true}}else{throw"添加失败"}};this.passengersDelete=function(datas){var url="https://kyfw.12306.cn/otn/passengers/delete";datas.isUserSelf="N";var json=doPost(url,datas);json=strToJson(json);var data=json.data;if(data!==undefined){var flag=data.flag;if(!flag){var message=data.message;if(message!==undefined){throw message}else{throw"删除失败"}}else{return true}}else{throw"删除失败"}};this.passengersEditSave=function(datas){var url="https://kyfw.12306.cn/otn/passengers/edit";var json=doPost(url,datas);json=strToJson(json);var data=json.data;if(data!==undefined){var flag=data.flag;if(!flag){var message=data.message;if(message!==undefined){throw message}else{throw"修改失败"}}else{return true}}else{throw"修改失败"}};function editSearchPwd(IVR_passwd,_IVR_passwd,_loginPwd){var url="https://kyfw.12306.cn/otn/userSecurity/editSearchPwd";var datas={"IVR_passwd":IVR_passwd,"_IVR_passwd":_IVR_passwd,"_login_passwd":_loginPwd};var json=doPost(url,datas);return json}function doEditSafeQuest(pwd_question,pwd_answer,_loginPwd){var url="https://kyfw.12306.cn/otn/userSecurity/doEditSafeQuest";var datas={"pwd_answer":pwd_answer,"pwd_question":pwd_question,"_otherQuest":"","_loginPwd":_loginPwd};var json=doPost(url,datas);return json}function doEditTel(mobile_no,_loginPwd){var url="https://kyfw.12306.cn/otn/userSecurity/doEditTel";var datas={"mobile_no":mobile_no,"_loginPwd":_loginPwd};var json=doPost(url,datas);return json}function editLoginPwd(password,_loginPwd){var url="https://kyfw.12306.cn/otn/userSecurity/editLoginPwd";var datas={"password":_loginPwd,"password_new":password,"confirmPassWord":password};var json=doPost(url,datas);return json}function doEditSafeEmail(email,_loginPwd){var url="https://kyfw.12306.cn/otn/userSecurity/doEditSafeEmail";var datas={"_email":email,"_loginPwd":_loginPwd};var json=doPost(url,datas);return json}function doIntegrationPwd(oldPwd,newPwd,comfPwd){var url="https://kyfw.12306.cn/otn/userSecurity/doIntegrationPwd";var datas={"oldPwd":oldPwd,"newPwd":newPwd,"comfPwd":comfPwd};var json=doPost(url,datas);return json}this.processUserSecurity=function(type,params){var ret;switch(type){case 1:ret=editLoginPwd(params[0],params[1]);break;case 2:ret=editSearchPwd(params[0],params[1],params[2]);break;case 4:ret=doEditSafeEmail(params[0],params[1]);break;case 6:ret=doEditTel(params[0],params[1]);break;case 8:ret=doEditSafeQuest(params[0],params[1],params[2]);break;case 10:ret=doIntegrationPwd(params[0],params[1],params[2]);break;default:break}ret=strToJson(ret);var data=ret.data;var message;if(data!==undefined){var flag=data.flag;if(!flag){message=data.message;if(message!==undefined){throw message}}else{}}else{var messages=ret.messages;if(messages!==undefined&&messages.length>0){message=messages[0];throw message}}return ret};this.getBindTel=function(){var url="https://kyfw.12306.cn/otn/userSecurity/bindTel";var datas={};datas.req_flag="init";var content=doPost(url,datas);if(content.contains("您好，请")){throw"未登录"}var ret=content.getString('<div class="r-txt">',"<");return ret};this.getSafeEmail=function(){var url="https://kyfw.12306.cn/otn/userSecurity/safeEmail";var datas={};datas.req_flag="init";var content=doPost(url,datas);if(content.contains("您好，请")){throw"未登录"}var index=content.indexOf("原电子邮箱");content=content.substr(index+5);var ret=content.getString('<div class="r-txt">',"<");return ret};function getKey(key){if(!key.contains("：")){return""}var index1=key.indexOf("：");key=key.substr(0,index1);index1=key.lastIndexOf(">");if(index1>=0){key=key.substr(index1)}return key}function getRadioLabel(line){var label;if(line.contains("<label for=")){label=line.getString('">',"<")}else{label=line.getString("<label>","<")}return label}this.queryPersonInfobase=function(url,datas,register){var content;if(datas===undefined||datas===null){content=doPost(url)}else{content=doPost(url,datas)}if(content.length===0){return{"未登录":"true"}}if(register===undefined&&content.contains("您好，请")){return{"未登录":"true"}}if(content.contains("系统维护中")){throw"系统维护中"}var split=content.split("\n");var value;var name;var key;var label;var radios;var ret={};for(var i=0;i<split.length;i++){var line=split[i];if(line.startsWith("姓名")&&ret["userDTO.loginUserDTO.name"]===undefined){if(!split[i+1].contains("input")){i++;
line=split[i];value=line.removeHtmlTag();name="userDTO.loginUserDTO.name";if(value.length>0){ret[name]={"value":value}}continue}}if(line.startsWith("姓 名")&&ret.passenger_name===undefined){if(!split[i+1].contains("input")){i++;line=split[i];value=line.removeHtmlTag();name="passenger_name";if(value.length>0){ret[name]={"value":value}}continue}}if(line.startsWith("证件号码")&&ret["userDTO.loginUserDTO.id_no"]===undefined){if(!split[i+1].contains("input")){i++;line=split[i];value=line.removeHtmlTag();name="userDTO.loginUserDTO.id_no";if(value.length>0){ret[name]={"value":value}}continue}}if(line.contains("核验状态")){i++;line=split[i];value=line.removeHtmlTag();name="status";if(value.length>0){ret[name]={"value":value}}continue}if(line.contains("国家/地区：")&&ret["国家/地区"]===undefined){if(!split[i+1].contains("select")){i++;line=split[i];value=line.removeHtmlTag();name="国家/地区";if(value.length>0){ret[name]={"value":value}}continue}}if(line.contains("证件类型：")&&ret["证件类型"]===undefined){if(!split[i+1].contains("select")){i++;line=split[i];value=line.removeHtmlTag();name="证件类型";if(value.length>0){ret[name]={"value":value}}continue}}if(line.contains("<input")||line.contains("<select ")){if(line.contains('type="text"')||line.contains('type="hidden"')){value=line.getString('value="','"');if(value===null){value=""}key=getKey(split[i-1]);name=line.getString('name="','"');if(name!==null){ret[name]={"type":"text","lable":key,"value":value}}}else{if(line.contains('type="radio"')){radios=[];key=getKey(split[i-1]);name=line.getString('name="','"');ret[name]={"label":key,"type":"radio","radios":radios};while(!line.contains("checked")&&!line.contains("</div>")){if(line==="</span>"){line=split[++i];continue}if(line.contains("</div>")){break}value=line.getString('value="','"');line=split[++i];if(line.contains("</div>")){break}while(!line.contains("<label")){line=split[++i];if(line.contains("</div>")){break}}label=getRadioLabel(line);line=split[++i];radios.push({"value":value,"label":label})}if(!line.contains("checked")){continue}value=line.getString('value="','"');if(value===null){value=""}line=split[++i];while(!line.contains("<label")){line=split[++i]}label=getRadioLabel(line);line=split[++i];radios.push({"value":value,"label":label});ret[name].value=value;line=split[++i];while(!line.contains("</div>")){if(!line.contains('type="radio"')){line=split[++i];continue}value=line.getString('value="','"');if(line.contains("checked")){ret[name].value=value}line=split[++i];while(!line.contains("<label")){line=split[++i]}label=getRadioLabel(line);line=split[++i];radios.push({"value":value,"label":label})}}else{if(line.contains('type="select"')||line.contains("<select ")){name=line.getString('name="','"');value=line.getString('value="','"');if(value===null){value=""}key=getKey(split[i-1]);radios=[];ret[name]={"value":value,"lable":key,"type":"select","options":radios};while(line.contains("<option")){line=line.getString("<option");var index=line.indexOf("/option");if(index>=0){line=line.substr(0,index)}else{index=line.indexOf("</span>");if(index>=0){line=line.substr(0,index)}}value=line.getString('value="','"');label=null;if(line.contains("><span>")){label=line.getString("><span>")}else{label=line.getString('">',"<")}if(line.contains("selected")){ret[name].value=value}radios.push({"value":value,"label":label});line=split[++i];if(line==="</option>"){line=split[++i]}}}}}}}return ret}}();var submitOrder=new function(){var p={ticket_type:{adult:"1",child:"2",student:"3",disability:"4"},ticket_type_name:{"1":"成人票","2":"孩票","3":"学生票","4":"伤残军人票"},tour_flag:{dc:"dc",wc:"wc",fc:"fc",gc:"gc",lc1:"l1",lc2:"l2"},passenger_type:{adult:"1",child:"2",student:"3",disability:"4"},passenger_card_type:{two:"1",one:"2",tmp:"3",passport:"B",hongkong_macau:"C",taiwan:"G"},request_flag:{isAsync:"1"},ticket_query_flag:{query_commom:"00",query_student:"0X00"},seatType:{yz_type:"1"},special_areas:{lso:"LSO",dao:"DAO",ado:"ADO",nqo:"NQO",tho:"THO"}};var h,a,d,e,n,g;this.clear=function(){a=null;d=null;h=null;n=null;e=null;g=null};this.submitOrderRequest=function(t,u){var f="https://kyfw.12306.cn/otn/leftTicket/submitOrderRequest";var w=t.secretStr;var v;var c=0;while(c++<MAX_RETRY_COUNT){var r={"secretStr":decodeURIComponent(w),"train_date":"2013-12-23","back_train_date":"2013-12-29","tour_flag":"dc","purpose_codes":u,"query_from_station_name":"","query_to_station_name":""};addKey("https://kyfw.12306.cn/otn/leftTicket/init",r);v=doPost(f,r);v=strToJson(v);if(!(v.status!==true&&v.messages!==undefined&&v.messages[0].indexOf("网路繁忙")>=0)){break}}var s=v.status;if(!s){if(v.messages!==undefined){var q=v.messages[0].removeHtmlTag();throw q}else{throw"错误！"}}j();this.ticketInfoForPassengerForm=a;this.orderRequestDTO=d};function j(){var f="https://kyfw.12306.cn/otn/confirmPassenger/initDc";var s=doPost(f);processKey(s);h=s.getString("globalRepeatSubmitToken = '","'");var r=s.getString("var ticketInfoForPassengerForm=",";");var c=s.getString("var orderRequestDTO=",";");var q=s.getString("var init_seatTypes=",";");
a=strToJson(r);d=strToJson(c);e=strToJson(q)}this.getPassengerDTOs=function(){var f="https://kyfw.12306.cn/otn/confirmPassenger/getPassengerDTOs";var c={"REPEAT_SUBMIT_TOKEN":h};var q=doPost(f,c);q=strToJson(q);return q};this.checkRandCodeAnsyn=function(s){var q="https://kyfw.12306.cn/otn/passcodeNew/checkRandCodeAnsyn";var c={"REPEAT_SUBMIT_TOKEN":h,"rand":"randp","randCode":s};var r=doPost(q,c);var f=r.data;if(f==="N"){throw"校验码错误！"}};this.checkOrderInfo=function(w,u,q){n=u;g=q;var f="https://kyfw.12306.cn/otn/confirmPassenger/checkOrderInfo";var c=0;var r;var s;while(c++<MAX_RETRY_COUNT){var t={"REPEAT_SUBMIT_TOKEN":h,"bed_level_order_num":"000000000000000000000000000000","cancel_flag":"2","oldPassengerStr":n,"passengerTicketStr":g,"randCode":w,"tour_flag":a.tour_flag,"_json_att":""};addKey(c==1?null:"https://kyfw.12306.cn/otn/confirmPassenger/initDc",t);var x=doPost(f,t);x=strToJson(x);s=x.data;r=s.submitStatus;if(!(!r&&s.errMsg&&s.errMsg.indexOf("网路繁忙")>=0)){break}}if(!r){var v=s.errMsg.removeHtmlTag();throw v}};this.getQueueCount=function(){var q="https://kyfw.12306.cn/otn/confirmPassenger/getQueueCount";var c={"REPEAT_SUBMIT_TOKEN":h,"fromStationTelecode":d.from_station_telecode,"leftTicket":a.queryLeftTicketRequestDTO.ypInfoDetail,"purpose_codes":a.purpose_codes,"seatType":"1","stationTrainCode":d.station_train_code,"toStationTelecode":d.to_station_telecode,"train_no":d.train_no,"train_date":new Date(d.train_date.time).toString()};var r=doPost(q,c);r=strToJson(r);var f=r.status;if(!f){if(r.messages!==undefined){var s=r.messages[0].removeHtmlTag();throw s}else{throw"错误！"}}else{if(r.data.isRelogin=="Y"){throw"用户未登录"}}return r};this.confirmSingleForQueue=function(s){var v=a.tour_flag;var t;if(v==p.tour_flag.dc){t=ctx+"confirmPassenger/confirmSingleForQueue"}else{if(v==p.tour_flag.wc){t=ctx+"confirmPassenger/confirmGoForQueue"}else{if(v==p.tour_flag.fc){t=ctx+"confirmPassenger/confirmBackForQueue"}else{if(v==p.tour_flag.gc){t=ctx+"confirmPassenger/confirmResignForQueue"}else{throw"订票失败!旅程形式"+v+"为非法的旅程方式"}}}}var c={"REPEAT_SUBMIT_TOKEN":h,"key_check_isChange":a.key_check_isChange,"leftTicketStr":a.leftTicketStr,"purpose_codes":a.purpose_codes,"randCode":s,"train_location":a.train_location,"oldPassengerStr":n,"passengerTicketStr":g};var r=doPost(t,c);r=strToJson(r);var q=r.status;var u=r.data;if(!q){throw u.errMsg.removeHtmlTag()}var f=u.submitStatus;if(!f){throw u.errMsg.removeHtmlTag()}this.orderQueueWaitTime=new OrderQueueWaitTime(v,k,m);this.orderQueueWaitTime.start()};this.nextWait=function(){this.orderQueueWaitTime.timerJob()};function k(q,c,f){if(c<=5){i("订单已经提交，系统正在处理中，请稍等。",false,"",false,"work")}else{if(c>30*60){i("订单已经提交，预计等待时间超过30分钟，请耐心等待。",false,"",false,"queue")}else{i("订单已经提交，最新预估等待时间"+f+"，请耐心等待。",false,"",false,"queue")}}}function m(u,r,t){if(r==-1){var s="";if(u==p.tour_flag.dc){s=ctx+"confirmPassenger/resultOrderForDcQueue"}else{if(u==p.tour_flag.wc){s=ctx+"confirmPassenger/resultOrderForWcQueue"}else{if(u==p.tour_flag.fc){s=ctx+"confirmPassenger/resultOrderForFcQueue"}else{if(u==p.tour_flag.gc){s=ctx+"confirmPassenger/resultOrderForGcQueue"}}}}var c={"REPEAT_SUBMIT_TOKEN":h,"orderSequence_no":t.orderId};var q=doPost(s,c);var f=strToJson(q);postNotify("submitOK",my12306.getPayOrderInfo())}else{o(r,t)}}function l(s,c,r,q,f){postNotify("showError",s+r)}function i(s,c,r,q,f){postNotify("showOrderInfo",s)}function o(f,c){if(f==-1){return}else{if(f==-2){if(c.errorcode===0){l("订票失败!",true,"原因： "+c.msg,false,"lose")}else{l("订票失败!",true,"原因： "+c.msg,false,"lose")}}else{if(f==-3){l("哎呀,订票失败!",true,"订单已撤销",false,"lose")}else{l("订票失败!",true,"原因：有未完成的订单",false,"lose")}}}}this.pay_success=function(q){var f="https://kyfw.12306.cn/otn/payfinish/init";var r={"get_ticket_pass":q};var c=doPost(f,r);var s=c.getString("var payFlag=",";");return"'N'"!==s};this.TimeClose=function(r,u){if(u===undefined||u===null){u=""}var t;try{var s=Math.floor(r/(1000*60));var q=Math.floor(r/1000)%60;if(s<10){s="0"+s}if(q<10){q="0"+q}if(r>0){t=u+s+"分"+q+"秒"}else{t=u+"00秒"}return[r,t]}catch(v){}finally{}};this.getOrderInfo=function(r){var f=r.residueTime;if(!f){return[2222,"33fdfasf"]}f=parseInt(f.replace("'",""),10);var c=r.beginTime;var q=r.loseTime;var s;if(f>0){s=this.TimeClose(f*60*1000)}else{s=this.TimeClose(q-c)}return s};this.cancelNoCompleteMyOrder=function(q,c){var r="https://kyfw.12306.cn/otn/queryOrder/cancelNoCompleteMyOrder";var v={"sequence_no":q,"cancel_flag":c};var s=doPost(r,v);s=strToJson(s);var f=s.status;if(f!==undefined){var u=s.data;var t=u.existError;if(t!==undefined&&t==="Y"){return false}}return true};this.cancelOrder=function(s,w,f){var c="https://kyfw.12306.cn/otn/payOrder/cancel";var q={"sequence_no":s,"parOrderDTOJson":w,"orderRequestDTOJson":f};var x=doPost(c,q);x=strToJson(x);var t=x.status;if(t!==undefined){var u=x.data;var r=u.cancelStatus;if(r!==undefined){return true}else{var v=u.errorMessage;throw v}}return false}}();function OrderQueueWaitTime(e,f,d){this.tourFlag=e;this.waitMethod=f;this.finishMethod=d;
this.dispTime=1;this.nextRequestTime=1;this.isFinished=false;this.waitObj=null;this.start=function(){var c=this;c.timerJob()};this.timerJob=function(){if(this.isFinished){return}if(this.dispTime<=0){this.isFinished=true;this.finishMethod(this.tourFlag,this.dispTime,this.waitObj);return}if(this.dispTime==this.nextRequestTime){this.getWaitTime()}var h=this.dispTime;var i="";var g=parseInt(h/60,10);if(g>=1){i=g+"分";h=h%60}else{i="1分"}this.waitMethod(this.tourFlag,this.dispTime>1?--this.dispTime:1,i)};this.getWaitTime=function(){var h=this;var i=doGet(ctx+"confirmPassenger/queryOrderWaitTime?random="+new Date().getTime()+"&tourFlag="+h.tourFlag+"&REPEAT_SUBMIT_TOKEN="+submitOrder.token);var l=strToJson(i);var j=l.data;if(!j.queryOrderWaitTimeStatus){throw"用户未登录"}else{if(j!==null){h.waitObj=j;h.dispTime=j.waitTime;var k=parseInt(j.waitTime/1.5,10);k=k>60?60:k;var g=j.waitTime-k;h.nextRequestTime=g<=0?1:g}}}}var userRegister=new function(){this.agreeRule=function(f,c,g){var d="";var a="https://kyfw.12306.cn/otn/regist/agreeRule";var e={"loginUserDTO.user_name":f,"userDTO.password":c,"userDTO.IVR_passwd":g,"confirmIvr_pwd":g,"confirmPassWord":c,"otherpasswordQuestion":""};return my12306.queryPersonInfobase(a,e,true)};this.checkUserName=function(e){var d="";var a="https://kyfw.12306.cn/otn/regist/checkUserName?user_name="+e;var c=doGet(a);c=strToJson(c);if(c.data!==undefined&&!c.data){return true}else{throw"该用户名已经被占用，请重新选择用户名！"}};this.subDetail=function(f){var l=f["userDTO.password"];var k=new RegExp("(?![a-z]+$|[0-9]+$|_+$)^[a-zA-Z0-9_]{6,}$");if(!k.test(l)){throw"登录密码格式错误：必须且只能包含字母，数字，下划线中的两种或两种以上！"}l=f["userDTO.email"];k=/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;if(!k.test(l)){throw"请输入有效的电子邮件地址！"}l=f["userDTO.mobile_no"];var m=l.length;if(m!=11||!(/^[0-9]+$/.test(l))){throw"您输入的手机号码不是有效的格式！"}var e=f["loginUserDTO.id_type_code"];l=f["loginUserDTO.id_no"];var m=l.length;if(e==="1"&&m!=18){throw"请正确输入18位的身份证号！"}var i="";var a="https://kyfw.12306.cn/otn/regist/subDetail";var n=doPost(a,f);n=strToJson(n);var h=n.data;if(h!==undefined){var j=h.flag;if(j!=="N"){return this.initSuc(h["userDTO.email"])}else{var g=n.messages;throw g[0]}}};this.initSuc=function(c){var e="";var a="https://kyfw.12306.cn/otn/regist/initSuc";var d=doPost(a,{"email":c});if(d.contains("邮件已发送到您的邮箱")){return d.getString("感谢您的注册。</div>","</div>").removeHtmlTag().replace("\n","")}throw"注册失败！"}}();function fw(c){var a=false;return a}function bin216(d){var c,a,e="",f;d+="";b="";for(c=0,a=d.length;c<a;c++){b=d.charCodeAt(c);f=b.toString(16);e+=f.length<2?"0"+f:f}return e}var Base32=new function(){var d=2654435768;function a(j,f){var h=j.length;var k=(h-1)<<2;if(f){var e=j[h-1];if((e<k-3)||(e>k)){return null}k=e}for(var g=0;g<h;g++){j[g]=String.fromCharCode(j[g]&255,j[g]>>>8&255,j[g]>>>16&255,j[g]>>>24&255)}if(f){return j.join("").substring(0,k)}else{return j.join("")}}function c(g,f){var j=g.length;var e=[];for(var h=0;h<j;h+=4){e[h>>2]=g.charCodeAt(h)|g.charCodeAt(h+1)<<8|g.charCodeAt(h+2)<<16|g.charCodeAt(h+3)<<24}if(f){e[e.length]=j}return e}this.encrypt=function(j,t){if(j==""){return""}var u=c(j,true);var i=c(t,false);if(i.length<4){i.length=4}var h=u.length-1;var o=u[h],r=u[0];var s,m,g,f=Math.floor(6+52/(h+1)),l=0;while(0<f--){l=l+d&4294967295;m=l>>>2&3;for(g=0;g<h;g++){r=u[g+1];s=(o>>>5^r<<2)+(r>>>3^o<<4)^(l^r)+(i[g&3^m]^o);o=u[g]=u[g]+s&4294967295}r=u[0];s=(o>>>5^r<<2)+(r>>>3^o<<4)^(l^r)+(i[g&3^m]^o);o=u[h]=u[h]+s&4294967295}return a(u,false)}};var keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";function encode32(d){d=escape(d);var a="";var l,j,g="";var k,h,f,e="";var c=0;do{l=d.charCodeAt(c++);j=d.charCodeAt(c++);g=d.charCodeAt(c++);k=l>>2;h=((l&3)<<4)|(j>>4);f=((j&15)<<2)|(g>>6);e=g&63;if(isNaN(j)){f=e=64}else{if(isNaN(g)){e=64}}a=a+keyStr.charAt(k)+keyStr.charAt(h)+keyStr.charAt(f)+keyStr.charAt(e);l=j=g="";k=h=f=e=""}while(c<d.length);return a}function aj(){var a=new Object();a["jsv"]=window.helperVersion;jq({url:"/otn/dynamicJs/snpjymi",data:a,type:"POST",success:function(c,d){if(timmer){clearInterval(timmer)}},error:function(c,e,d){}})}function gc(i){var h="";var k=["selectSeatType","ev_light","ev_light","fishTimeRangePicker","updatesFound","tipScript","refreshButton","fish_clock","refreshStudentButton","btnMoreOptions","btnAutoLogin","fish_button","defaultSafeModeTime","ticket-navigation-item"];var n=false;if(n){h+="0"}else{h+="1"}var e=["btnMoreOptions","refreshStudentButton","fishTimeRangePicker","helpertooltable","outerbox","updateInfo","fish_clock","refreshStudentButton","btnAutoRefresh","btnAutoSubmit","btnRefreshPassenger","autoLogin","bnAutoRefreshStu","orderCountCell","refreshStudentButton","enableAdvPanel","autoDelayInvoke","refreshButton","refreshTimesBar","chkAllSeat"];var f=false;if(f){h+="0"}else{h+="1"}var j=["helperVersion"];var l=j?j.length:0;var d=false;var a=[".enter_right>.enter_enw>.enter_rtitle",".objbox td"];var g=false;if(g){h+="0"}else{h+="1"}var c=[{key:".enter_right",values:["亲","抢票","助手"]},{key:".cx_form",values:["点发车","刷票"]},{key:"#gridbox",values:["只选","仅选","checkBox","checkbox"]},{key:".enter_w",values:["助手"]}];
var m=false;if(m){h+="0"}else{h+="1"}if(h.indexOf("0")>-1){aj()}return i+":"+h}function processKey(e){var d="https://kyfw.12306.cn/otn/dynamicJs/"+e.getString('<script src="/otn/dynamicJs/','"');var g=doGet(d);var c=g.getString("var key='","'");if(!c){return false}var f="https://kyfw.12306.cn/otn/dynamicJs/"+g.getString("/otn/dynamicJs/","'");doPost(f);dynamicKey=c;var a=gc(c).split(":");dynamicValue=encode32(bin216(Base32.encrypt(a[1],a[0])))}function addKey(a,d){if(a!=null){var c=doGet(a);processKey(c)}d[dynamicKey]=dynamicValue;d["myversion"]="undefined"}var login=new function(){this.login=function(i,j,h){var k;var c;var a=0;while(a++<MAX_RETRY_COUNT){var g=doPost("https://kyfw.12306.cn/otn/passcodeNew/checkRandCodeAnsyn",{"rand":"sjrand","randCode":h,"randCode_validate":""});k=strToJson(g);if(!(k.status!==true&&k.messages!==undefined&&k.messages[0]==="非法请求")){break}}if(k.status!==true){throwError(k)}a=0;while(a++<MAX_RETRY_COUNT){var d={"loginUserDTO.user_name":i,"userDTO.password":j,"randCode":h,"randCode_validate":""};addKey("https://kyfw.12306.cn/otn/login/init#",d);url="https://kyfw.12306.cn/otn/login/loginAysnSuggest";g=doPost(url,d);k=strToJson(g);if(!(k.status!==true&&k.messages!==undefined&&k.messages[0].indexOf("网路繁忙")>=0)){break}}var e=k.data;if(e===undefined||e.length===0){throwError(k)}var f=e.loginCheck;if(f===undefined){throwError(k)}if(f===undefined||(f!=="Y")){throwError(k)}return my12306.queryPersonInfo()};this.checkUser=function(){var c="https://kyfw.12306.cn/otn/login/checkUser";var a={};var d=doPost(c,a);d=strToJson(d);var e=d.data;return e.flag};this.logout=function(){userInfo=null;var a="https://kyfw.12306.cn/otn/login/loginOut";doGet(a)};this.getWelcomeInfo=function(){if(userInfo===null||userInfo["userDTO.loginUserDTO.name"]===undefined){return null}else{return"欢迎您，"+userInfo["userDTO.loginUserDTO.name"].value+(userInfo["userDTO.sex_code"].value==="M"?"先生":"女士")}}}();